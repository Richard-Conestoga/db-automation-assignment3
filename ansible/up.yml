---
- name: Provision MySQL Database Environment
  hosts: localhost
  connection: local
  gather_facts: false
  vars_files:
    - group_vars/all.yml

  tasks:
    - name: Remove any existing MySQL container
      community.docker.docker_container:
        name: "{{ mysql_container_name }}"
        state: absent
      ignore_errors: yes

    - name: Create flyway_network (if not exists)
      community.docker.docker_network:
        name: flyway_network
        state: present

    - name: "Start MySQL container"
      community.docker.docker_container:
        name: "{{ mysql_container_name }}"
        image: mysql:8.0
        state: started
        networks:
          - name: flyway_network
        ports:
          - "{{ mysql_port }}:3306"
        env:
          MYSQL_ROOT_PASSWORD: "{{ mysql_root_password }}"
          MYSQL_DATABASE: "{{ mysql_database }}"
          MYSQL_USER: "{{ mysql_user }}"
          MYSQL_PASSWORD: "{{ mysql_password }}"
        healthcheck:
          test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
          interval: 10s
          timeout: 5s
          retries: 10

    - name: Wait until MySQL container is healthy
      community.docker.docker_container_info:
        name: "{{ mysql_container_name }}"
      register: mysql_info
      until: mysql_info.container.State.Health.Status == "healthy"
      retries: 10
      delay: 6

    - name: "Sanity-check: Test DNS resolution on Docker network"
      community.docker.docker_container:
        name: "dns-test"
        image: busybox
        networks:
          - name: flyway_network
        command: "ping -c 2 {{ mysql_container_name }}"
        state: started
        cleanup: yes
        detach: false

    - name: Run Flyway migrations
      community.docker.docker_container:
        name: flyway_migration
        image: "flyway/flyway:{{ flyway_version }}"
        state: started
        detach: false
        cleanup: yes
        networks:
          - name: flyway_network
        volumes:
          - "{{ playbook_dir }}/../flyway/migrations_initial:/flyway/sql/initial"
          - "{{ playbook_dir }}/../flyway/migrations_incremental:/flyway/sql/incremental"
        command: >
          -url=jdbc:mysql://{{ mysql_container_name }}:3306/{{ mysql_database }}
          -user={{ mysql_user }}
          -password={{ mysql_password }}
          -locations=filesystem:/flyway/sql/initial,filesystem:/flyway/sql/incremental
          -connectRetries=10
          migrate

    - name: Display success message
      debug:
        msg:
          - "MySQL environment provisioned successfully!"
          - "All migrations (initial + incremental) completed"
